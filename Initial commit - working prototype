import json
import os
from enum import Enum
from typing import Dict, Any, List, Optional, Tuple
from dataclasses import dataclass, asdict
from datetime import datetime
import sys


class UserRole(Enum):
    JUDGE = "—Å—É–¥—å—è"
    LAWYER = "–∞–¥–≤–æ–∫–∞—Ç"
    PROSECUTOR = "–ø—Ä–æ–∫—É—Ä–æ—Ä"


@dataclass
class LegalCase:
    case_id: str
    description: str
    case_type: str
    parties: List[str]
    claims: List[str]
    documents: List[str]
    created_at: str
    user_role: str
    status: str = "–≤ —Ä–∞–±–æ—Ç–µ"


@dataclass
class AnalysisResult:
    similar_cases: List[Dict]
    legal_norms: List[str]
    risk_score: float
    recommendations: List[str]
    contradictions: List[str]
    predicted_outcome: str = ""
    role_specific_insights: List[str] = None


@dataclass
class PersonalizedReport:
    role: UserRole
    generated_at: str
    case_id: str
    case_description: str
    key_insights: List[str]
    actions: List[str]
    warnings: List[str]
    documents_summary: List[str]
    raw_analysis: AnalysisResult


class DataManager:
    def __init__(self, data_dir: str = "data"):
        self.data_dir = data_dir
        self.cases_file = os.path.join(data_dir, "cases.json")
        self.reports_dir = os.path.join(data_dir, "reports")
        self._ensure_directories()

    def _ensure_directories(self):
        os.makedirs(self.data_dir, exist_ok=True)
        os.makedirs(self.reports_dir, exist_ok=True)
        if not os.path.exists(self.cases_file):
            with open(self.cases_file, 'w', encoding='utf-8') as f:
                json.dump([], f)

    def save_case(self, case: LegalCase) -> bool:
        try:
            with open(self.cases_file, 'r', encoding='utf-8') as f:
                cases = json.load(f)
            case_dict = asdict(case)
            cases.append(case_dict)
            with open(self.cases_file, 'w', encoding='utf-8') as f:
                json.dump(cases, f, ensure_ascii=False, indent=2)
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {e}")
            return False

    def load_cases(self) -> List[Dict]:
        try:
            with open(self.cases_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception:
            return []

    def save_report(self, report: PersonalizedReport):
        try:
            report_dict = asdict(report)
            report_dict['role'] = report_dict['role']['value']
            filename = f"report_{report.case_id}_{report.role.value}.json"
            filepath = os.path.join(self.reports_dir, filename)
            with open(filepath, 'w', encoding='utf-8') as f:
                json.dump(report_dict, f, ensure_ascii=False, indent=2)
            return filepath
        except Exception:
            return None


class RoleSpecificQuestionnaire:
    @staticmethod
    def get_questions_for_role(role: UserRole) -> List[Tuple[str, str]]:
        if role == UserRole.JUDGE:
            return [
                ("qualification", "–ò–º–µ—é—Ç—Å—è –ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è/—Å–ø–æ—Ä–∞?"),
                ("evidence", "–ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö —Å—Ç–æ—Ä–æ–Ω?"),
                ("expertise", "–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—É–¥–µ–±–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã?"),
                ("norms", "–ö–∞–∫–∏–µ –Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞ –≤—ã–∑—ã–≤–∞—é—Ç –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–∏?"),
                ("similarity", "–ò–∑–≤–µ—Å—Ç–Ω—ã –ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –¥–µ–ª–∞ –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ–≥–æ —Å—É–¥–∞?")
            ]
        elif role == UserRole.LAWYER:
            return [
                ("strategy", "–ö–∞–∫–æ–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ª—å –ø–æ –¥–µ–ª—É (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ –ø—Ä–∞–≤–∞ –∏ —Ç.–¥.)?"),
                ("weaknesses", "–ö–∞–∫–∏–µ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞—à–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?"),
                ("opponent", "–ö–∞–∫–∏–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —É –ø—Ä–æ—Ç–∏–≤–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã?"),
                ("petitions", "–ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ —Ö–æ–¥–∞—Ç–∞–π—Å—Ç–≤–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∑–∞—è–≤–∏—Ç—å?"),
                ("evidence_needed", "–ö–∞–∫–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è?")
            ]
        elif role == UserRole.PROSECUTOR:
            return [
                ("evidence_completeness", "–ü–æ–ª–Ω–æ—Ç–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ –¥–µ–ª—É?"),
                ("qualification_match", "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç–∞—Ç—å–µ –£–ö –†–§?"),
                ("circumstances", "–£—á—Ç–µ–Ω—ã –ª–∏ –≤—Å–µ —Å–º—è–≥—á–∞—é—â–∏–µ/–æ—Ç—è–≥—á–∞—é—â–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞?"),
                ("investigation", "–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ?"),
                ("witnesses", "–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏–π —Å–≤–∏–¥–µ—Ç–µ–ª–µ–π?")
            ]

    @staticmethod
    def get_document_types_for_role(role: UserRole) -> List[str]:
        if role == UserRole.JUDGE:
            return ["–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ", "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Å—Ç–æ—Ä–æ–Ω", "–•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–∞",
                    "–ó–∞–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤", "–ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ—à–µ–Ω–∏—è"]
        elif role == UserRole.LAWYER:
            return ["–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–ü–æ–∑–∏—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞", "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
                    "–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∏—Å–∫", "–†–∞—Å—á–µ—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"]
        elif role == UserRole.PROSECUTOR:
            return ["–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–æ–≤–µ—Ä–∫–∏", "–û–±–≤–∏–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ",
                    "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞", "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏", "–ü—Ä–æ—Ç–æ–∫–æ–ª—ã"]


class LegalAnalyticsCore:
    @staticmethod
    def analyze_case(case: LegalCase, role_answers: Dict[str, str] = None) -> AnalysisResult:
        case_type = case.case_type.lower()

        if "–∞—Ä–±–∏—Ç—Ä–∞–∂" in case_type or "–≥—Ä–∞–∂–¥–∞–Ω" in case_type:
            similar_cases = [
                {"id": "–ê40-123456/2023", "court": "–ê–° –≥. –ú–æ—Å–∫–≤—ã", "outcome": "–∏—Å–∫ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω", "similarity": 0.87},
                {"id": "–ê41-789012/2022", "court": "–ê–° –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "outcome": "—á–∞—Å—Ç–∏—á–Ω–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω",
                 "similarity": 0.76}
            ]
            legal_norms = ["—Å—Ç. 15 –ì–ö –†–§", "—Å—Ç. 395 –ì–ö –†–§", "–ø. 3 —Å—Ç. 10 –ì–ö –†–§"]
            predicted_outcome = "—á–∞—Å—Ç–∏—á–Ω–æ–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ"
        elif "—É–≥–æ–ª–æ–≤" in case_type:
            similar_cases = [
                {"id": "1-123/2023", "court": "–ú–æ—Å–≥–æ—Ä—Å—É–¥", "outcome": "–æ–±–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–≥–æ–≤–æ—Ä", "similarity": 0.92}
            ]
            legal_norms = ["—Å—Ç. 105 –£–ö –†–§", "—Å—Ç. 158 –£–ö –†–§"]
            predicted_outcome = "–æ–±–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–≥–æ–≤–æ—Ä"
        else:
            similar_cases = [
                {"id": "33–∞-1234/2023", "court": "–í–° –†–§", "outcome": "–æ—Ç–∫–∞–∑ –≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–∏", "similarity": 0.55}
            ]
            legal_norms = ["—Å—Ç. 46 –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏ –†–§"]
            predicted_outcome = "–æ—Ç–∫–∞–∑ –≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–∏"

        risk_score = 0.65
        claims_text = " ".join(case.claims).lower()
        if any(word in claims_text for word in ["–Ω–µ—É—Å—Ç–æ–π–∫", "—à—Ç—Ä–∞—Ñ", "–ø–µ–Ω—è"]):
            risk_score = 0.82

        recommendations = []
        contradictions = []
        role_insights = []

        if case.user_role == "—Å—É–¥—å—è":
            recommendations = [
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å–∫–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —Å—Ç. 131 –ì–ü–ö –†–§",
                "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–ø—Ä–æ—Å –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã",
                "–°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–∞–∫—Ç–∏–∫–æ–π —Å—É–¥–æ–≤ —Å—É–±—ä–µ–∫—Ç–∞"
            ]
            if role_answers and role_answers.get("evidence") == "–¥–∞":
                contradictions.append("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø. –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ")

        elif case.user_role == "–∞–¥–≤–æ–∫–∞—Ç":
            recommendations = [
                "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ö–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ–± –∏—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤",
                "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –¥–µ–ª–æ ‚Ññ–ê40-123456/2023",
                "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è —É –∫–ª–∏–µ–Ω—Ç–∞"
            ]
            if role_answers and "—Å–ª–∞–±" in role_answers.get("weaknesses", "").lower():
                role_insights.append("–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å–∏–ª–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–µ–Ω–Ω—É—é –±–∞–∑—É –ø–æ —Å–ª–∞–±—ã–º –º–µ—Å—Ç–∞–º")

        elif case.user_role == "–ø—Ä–æ–∫—É—Ä–æ—Ä":
            recommendations = [
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ —Å—Ç. 75 –£–ü–ö –†–§",
                "–£—Ç–æ—á–Ω–∏—Ç—å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤",
                "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –æ–±–≤–∏–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è"
            ]
            if role_answers and role_answers.get("evidence_completeness") == "–Ω–µ–ø–æ–ª–Ω–∞—è":
                role_insights.append("–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã")

        if len(case.documents) < 2:
            contradictions.append(f"–ú–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ({len(case.documents)}). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ.")

        return AnalysisResult(
            similar_cases=similar_cases,
            legal_norms=legal_norms,
            risk_score=risk_score,
            recommendations=recommendations,
            contradictions=contradictions,
            predicted_outcome=predicted_outcome,
            role_specific_insights=role_insights
        )


class ReportPersonalizer:
    @staticmethod
    def personalize(role: UserRole, case: LegalCase, analysis: AnalysisResult) -> PersonalizedReport:
        base_insights = [
            f"–ù–∞–π–¥–µ–Ω–æ {len(analysis.similar_cases)} –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –¥–µ–ª",
            f"–ü—Ä–∏–º–µ–Ω–∏–º—ã–µ –Ω–æ—Ä–º—ã: {', '.join(analysis.legal_norms[:3])}",
            f"–û—Ü–µ–Ω–∫–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤: {analysis.risk_score:.0%}",
            f"–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –∏—Å—Ö–æ–¥: {analysis.predicted_outcome}"
        ]

        if analysis.role_specific_insights:
            base_insights.extend(analysis.role_specific_insights)

        actions = []
        warnings = []

        if role == UserRole.JUDGE:
            actions = [
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –¥–µ–ª–∞",
                f"–°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–∞–∫—Ç–∏–∫–æ–π: {analysis.similar_cases[0]['id'] if analysis.similar_cases else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}",
                "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é —Å—É–º–º—É –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–æ–≥–æ–≤",
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤"
            ]
            warnings = [
                "–í–Ω–∏–º–∞–Ω–∏–µ: –≤–æ–∑–º–æ–∂–µ–Ω '—ç—Ñ—Ñ–µ–∫—Ç —è–∫–æ—Ä—è' –æ—Ç –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π —Å—É–º–º—ã –∏—Å–∫–∞",
                f"–ö–æ–Ω—Ç—Ä–æ–ª—å: {len(analysis.contradictions)} –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö"
            ]
        elif role == UserRole.LAWYER:
            actions = [
                f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –¥–µ–ª–æ {analysis.similar_cases[0]['id'] if analysis.similar_cases else 'N/A'}",
                "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ö–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ–± —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ",
                "–°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è",
                "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞"
            ]
            warnings = [
                f"–°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞: {len(analysis.contradictions)} –ø—É–Ω–∫—Ç–æ–≤ —Ç—Ä–µ–±—É—é—Ç –∑–∞—â–∏—Ç—ã",
                f"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞: {100 - analysis.risk_score * 100:.0f}%"
            ]
        elif role == UserRole.PROSECUTOR:
            actions = [
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –¥–ª—è —Å–æ—Å—Ç–∞–≤–∞",
                "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –æ–±–≤–∏–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è",
                "–°–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫–∏ –¥–∞–≤–Ω–æ—Å—Ç–∏",
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –∑–∞—â–∏—Ç—ã"
            ]
            warnings = [
                f"–†–∏—Å–∫ –æ—Ç–∫–∞–∑–∞ –≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–∏: {analysis.risk_score:.0%}",
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ —Å—Ç. 75 –£–ü–ö –†–§"
            ]

        documents_summary = []
        doc_types = RoleSpecificQuestionnaire.get_document_types_for_role(role)
        for i, doc in enumerate(case.documents[:3]):
            doc_type = doc_types[i] if i < len(doc_types) else "–î–æ–∫—É–º–µ–Ω—Ç"
            documents_summary.append(f"{doc_type}: {doc}")

        if len(case.documents) > 3:
            documents_summary.append(f"... –∏ –µ—â—ë {len(case.documents) - 3} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")

        return PersonalizedReport(
            role=role,
            generated_at=datetime.now().isoformat(),
            case_id=case.case_id,
            case_description=case.description[:100] + ("..." if len(case.description) > 100 else ""),
            key_insights=base_insights,
            actions=actions,
            warnings=warnings,
            documents_summary=documents_summary,
            raw_analysis=analysis
        )


class JusticeAIAssistant:
    def __init__(self):
        self.data_manager = DataManager()
        self.questionnaire = RoleSpecificQuestionnaire()
        self.core = LegalAnalyticsCore()
        self.personalizer = ReportPersonalizer()
        self.current_role = None

    def select_role(self) -> Optional[UserRole]:
        print("\n" + "=" * 50)
        print("–í–´–ë–ï–†–ò–¢–ï –í–ê–®–£ –†–û–õ–¨ (–∫–∞–∫ –≤ Figma-–º–∞–∫–µ—Ç–µ)")
        print("=" * 50)
        roles = list(UserRole)
        for i, role in enumerate(roles, 1):
            print(f"{i}. {role.value.upper()}")
        print("=" * 50)

        try:
            choice = int(input("–í–∞—à –≤—ã–±–æ—Ä (1-3): ")) - 1
            if 0 <= choice < len(roles):
                self.current_role = roles[choice]
                print(f"\n‚úì –í—ã–±—Ä–∞–Ω–∞ —Ä–æ–ª—å: {self.current_role.value.upper()}")
                return self.current_role
        except (ValueError, IndexError):
            pass
        print("\n‚ö† –†–æ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π —Ä–µ–∂–∏–º.")
        return None

    def create_case_for_role(self, role: UserRole) -> Optional[LegalCase]:
        print("\n" + "=" * 50)
        print(f"–°–û–ó–î–ê–ù–ò–ï –î–ï–õ–ê –î–õ–Ø {role.value.upper()}")
        print("=" * 50)

        try:
            case_id = input("–ù–æ–º–µ—Ä –¥–µ–ª–∞: ").strip() or f"–î–ï–õ–û-{datetime.now().strftime('%Y%m%d-%H%M')}"
            description = input("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: ").strip() or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
            case_type = input("–¢–∏–ø (–∞—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π/–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π/—É–≥–æ–ª–æ–≤–Ω—ã–π/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π): ").strip() or "–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π"

            print(f"\nüìé –¢–ò–ü–´ –î–û–ö–£–ú–ï–ù–¢–û–í –î–õ–Ø {role.value.upper()}:")
            doc_types = self.questionnaire.get_document_types_for_role(role)
            for dt in doc_types:
                print(f"  ‚Ä¢ {dt}")

            print("\nüìÅ –ó–ê–ì–†–£–ó–ö–ê –î–û–ö–£–ú–ï–ù–¢–û–í (–≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):")
            docs_input = input("–î–æ–∫—É–º–µ–Ω—Ç—ã: ").strip()
            documents = [d.strip() for d in docs_input.split(",") if d.strip()] or ["–û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã"]

            print("\nüìù –û–¢–í–ï–¢–¨–¢–ï –ù–ê –í–û–ü–†–û–°–´ –î–õ–Ø –í–ê–®–ï–ô –†–û–õ–ò:")
            questions = self.questionnaire.get_questions_for_role(role)
            answers = {}
            for key, question in questions:
                answer = input(f"\n{question}\n–û—Ç–≤–µ—Ç: ").strip()
                answers[key] = answer

            print("\nüìÑ –ò–°–ö–û–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø/–ü–û–ó–ò–¶–ò–Ø:")
            claims = []
            while True:
                claim = input("  –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ (–ø—É—Å—Ç–æ - –∑–∞–∫–æ–Ω—á–∏—Ç—å): ").strip()
                if not claim:
                    break
                claims.append(claim)

            parties = [f"–°—Ç–æ—Ä–æ–Ω–∞ {i + 1}" for i in range(2)]

            case = LegalCase(
                case_id=case_id,
                description=description,
                case_type=case_type,
                parties=parties,
                claims=claims or ["–ù–µ —É–∫–∞–∑–∞–Ω–æ"],
                documents=documents,
                created_at=datetime.now().isoformat(),
                user_role=role.value
            )

            if self.data_manager.save_case(case):
                print(f"\n‚úÖ –î–µ–ª–æ —Å–æ–∑–¥–∞–Ω–æ! –û—Ç–≤–µ—Ç—ã —É—á—Ç–µ–Ω—ã –≤ –∞–Ω–∞–ª–∏–∑–µ.")
                return case, answers

        except KeyboardInterrupt:
            print("\n\n‚ö† –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ")
        except Exception as e:
            print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")

        return None, {}

    def analyze_with_context(self, case: LegalCase, answers: Dict[str, str]) -> AnalysisResult:
        return self.core.analyze_case(case, answers)

    def generate_report(self, case: LegalCase, role: UserRole, answers: Dict[str, str] = None) -> Dict[str, Any]:
        analysis = self.analyze_with_context(case, answers or {})
        report = self.personalizer.personalize(role, case, analysis)
        saved_path = self.data_manager.save_report(report)

        return {
            "system": "AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–∞–≤–æ—Å—É–¥–∏—è v2.0",
            "user_role": report.role.value,
            "case_id": report.case_id,
            "case_description": report.case_description,
            "generated_at": report.generated_at,
            "report": {
                "key_insights": report.key_insights,
                "recommended_actions": report.actions,
                "warnings": report.warnings,
                "documents": report.documents_summary
            },
            "sources": {
                "similar_cases": report.raw_analysis.similar_cases,
                "legal_norms": report.raw_analysis.legal_norms
            },
            "role_context": f"–ê–Ω–∞–ª–∏–∑ —Å —É—á–µ—Ç–æ–º —Ä–æ–ª–∏ {role.value}",
            "saved_to": saved_path,
            "disclaimer": "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–æ—Å—è—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä."
        }


class UserInterface:
    def __init__(self):
        self.assistant = JusticeAIAssistant()
        self.current_case = None
        self.current_answers = {}

    def display_main_menu(self):
        while True:
            print("\n" + "=" * 50)
            print("AI-–ê–°–°–ò–°–¢–ï–ù–¢ –î–õ–Ø –ü–†–ê–í–û–°–£–î–ò–Ø")
            print("–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ –º–∞–∫–µ—Ç—É Figma")
            print("=" * 50)

            if self.assistant.current_role:
                print(f"–¢–ï–ö–£–©–ê–Ø –†–û–õ–¨: {self.assistant.current_role.value.upper()}")
            else:
                print("–†–û–õ–¨: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞")

            print("\n1. üë§ –í—ã–±—Ä–∞—Ç—å/—Å–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å")
            print("2. üìÅ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –¥–µ–ª–æ (—Å —É—á–µ—Ç–æ–º —Ä–æ–ª–∏)")
            print("3. üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–ª–æ")
            print("4. üìä –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–µ–ª–∞")
            print("5. üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç")
            print("6. üìÑ –û—Ç—á–µ—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã")
            print("7. ‚ùå –í—ã—Ö–æ–¥")
            print("=" * 50)

            choice = input("–í—ã–±–æ—Ä (1-7): ").strip()

            if choice == "1":
                self.select_role_menu()
            elif choice == "2":
                self.create_case_menu()
            elif choice == "3":
                self.analyze_case_menu()
            elif choice == "4":
                self.view_cases_menu()
            elif choice == "5":
                self.generate_report_menu()
            elif choice == "6":
                self.view_reports_menu()
            elif choice == "7":
                print("\nüëã –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
                sys.exit(0)

    def select_role_menu(self):
        role = self.assistant.select_role()
        if role:
            print(f"\n‚úì –†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è {role.value.upper()}")
            print("–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ–ª–∞ –±—É–¥—É—Ç –∑–∞–¥–∞–≤–∞—Ç—å—Å—è")
            print("—Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤–∞—à–µ–π —Ä–æ–ª–∏.")
        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

    def create_case_menu(self):
        if not self.assistant.current_role:
            print("\n‚ö† –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –≤ –º–µ–Ω—é 1!")
            input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")
            return

        self.current_case, self.current_answers = self.assistant.create_case_for_role(self.assistant.current_role)
        if self.current_case:
            print(f"\n‚úÖ –ì–æ—Ç–æ–≤–æ! –°–æ–∑–¥–∞–Ω–æ –¥–µ–ª–æ: {self.current_case.case_id}")
            print("–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç.")
        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

    def analyze_case_menu(self):
        if not self.current_case:
            print("\n‚ö† –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–ª–æ!")
            input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")
            return

        print("\n" + "=" * 50)
        print(f"–ê–ù–ê–õ–ò–ó –î–ï–õ–ê: {self.current_case.case_id}")
        print("=" * 50)

        analysis = self.assistant.analyze_with_context(self.current_case, self.current_answers)

        print(f"\nüìà –û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:")
        print(f"  ‚Ä¢ –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –¥–µ–ª: {len(analysis.similar_cases)}")
        print(f"  ‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: {analysis.risk_score:.0%}")
        print(f"  ‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –∏—Å—Ö–æ–¥–∞: {analysis.predicted_outcome}")

        print(f"\n‚öñÔ∏è –ü–†–ò–ú–ï–ù–ò–ú–´–ï –ù–û–†–ú–´:")
        for norm in analysis.legal_norms:
            print(f"  ‚Ä¢ {norm}")

        if analysis.recommendations:
            print(f"\nüéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø {self.assistant.current_role.value.upper()}:")
            for rec in analysis.recommendations:
                print(f"  ‚Ä¢ {rec}")

        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

    def generate_report_menu(self):
        if not self.current_case:
            print("\n‚ö† –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–ª–∞!")
            input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")
            return

        print("\n" + "=" * 50)
        print("–ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–û–õ–ù–û–ì–û –û–¢–ß–ï–¢–ê")
        print("=" * 50)

        report = self.assistant.generate_report(
            self.current_case,
            self.assistant.current_role,
            self.current_answers
        )

        print(f"\nüìã –û–¢–ß–ï–¢ –î–õ–Ø: {report['user_role'].upper()}")
        print(f"–î–µ–ª–æ: {report['case_id']}")
        print(f"–û–ø–∏—Å–∞–Ω–∏–µ: {report['case_description']}")
        print("=" * 50)

        print("\nüîç –ö–õ–Æ–ß–ï–í–´–ï –í–´–í–û–î–´:")
        for insight in report['report']['key_insights']:
            print(f"  ‚Ä¢ {insight}")

        print("\nüéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
        for action in report['report']['recommended_actions']:
            print(f"  ‚Ä¢ {action}")

        print("\n‚ö† –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:")
        for warning in report['report']['warnings']:
            print(f"  ‚ö† {warning}")

        print("\nüìé –î–û–ö–£–ú–ï–ù–¢–´:")
        for doc in report['report']['documents']:
            print(f"  ‚Ä¢ {doc}")

        print(f"\n{report['role_context']}")
        print(f"\nüíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω" + (f" –≤: {report['saved_to']}" if report['saved_to'] else ""))
        print(f"\n{report['disclaimer']}")

        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

    def view_cases_menu(self):
        cases = self.assistant.data_manager.load_cases()
        print("\n" + "=" * 50)
        print(f"–ê–†–•–ò–í –î–ï–õ ({len(cases)})")
        print("=" * 50)

        if not cases:
            print("–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.")
        else:
            for i, case in enumerate(cases[-10:], 1):
                role_icon = "üë®‚Äç‚öñÔ∏è" if case.get('user_role') == "—Å—É–¥—å—è" else "üë®‚Äçüíº" if case.get(
                    'user_role') == "–∞–¥–≤–æ–∫–∞—Ç" else "üëÆ"
                print(f"\n{i}. {role_icon} {case['case_id']}")
                print(f"   {case['description'][:60]}...")
                print(f"   –†–æ–ª—å: {case.get('user_role', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}")
                print(f"   –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(case.get('documents', []))}")

        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")

    def view_reports_menu(self):
        reports_dir = self.assistant.data_manager.reports_dir
        print("\n" + "=" * 50)
        print("–°–û–•–†–ê–ù–ï–ù–ù–´–ï –û–¢–ß–ï–¢–´")
        print("=" * 50)

        if not os.path.exists(reports_dir):
            print("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        else:
            reports = [f for f in os.listdir(reports_dir) if f.endswith('.json')]
            if not reports:
                print("–û—Ç—á–µ—Ç–æ–≤ –Ω–µ—Ç.")
            else:
                for r in reports[-5:]:
                    print(f"\nüìÑ {r}")

        input("\n‚Üµ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...")


def main():
    print("\n" + "=" * 60)
    print("     AI-–ê–°–°–ò–°–¢–ï–ù–¢ –î–õ–Ø –ü–†–ê–í–û–°–£–î–ò–Ø v2.0")
    print("     (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –º–∞–∫–µ—Ç—É Figma)")
    print("=" * 60)
    print("\n–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:")
    print("‚Ä¢ –†–∞–∑–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å—É–¥—å–∏, –∞–¥–≤–æ–∫–∞—Ç–∞, –ø—Ä–æ–∫—É—Ä–æ—Ä–∞")
    print("‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Ä–æ–ª–∏")
    print("‚Ä¢ –£—á–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∞–Ω–∞–ª–∏–∑–µ")
    print("‚Ä¢ –ë–ª–∏–∑–∫–æ –∫ Figma-–º–∞–∫–µ—Ç—É")
    print("=" * 60)

    ui = UserInterface()
    ui.display_main_menu()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–æ")
    except Exception as e:
        print(f"\n‚ö† –û—à–∏–±–∫–∞: {e}")
